<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>カオゼロ（Chaos Zero Nightmare）｜セーブデータ計算機</title>
  <style>
    :root{--bg:#0f1115;--card:#171a21;--muted:#aab3c0;--text:#e8edf4;--accent:#7dd3fc;--danger:#f87171;--ok:#86efac;}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0f1115;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:1680px;margin:24px auto;padding:0 20px}
    h1{font-size:24px;margin:0 0 6px;font-weight:800;letter-spacing:.2px}
    h1 .en{font-size:.8em;color:var(--muted);font-weight:700}
    .sub{margin:0 2px 6px;font-size:12px;color:var(--muted)}
    .author{margin:0 2px 14px;font-size:12px;color:#9fb0c8}
    .tabs{display:flex;gap:8px;margin:10px 0 16px;flex-wrap:wrap}
    .tab{cursor:pointer;padding:8px 12px;border:1px solid #2a3140;border-radius:10px;background:#0e1218;color:#cfe2ff;user-select:none}
    .tab.active{background:linear-gradient(180deg,#f0f4ff,#cfe8ff);color:#0b0e13;font-weight:700}
    .grid{display:grid;gap:16px}
    @media(min-width:1200px){.grid{grid-template-columns:1.1fr 1.9fr}}
    .card{background:var(--card);border:1px solid #222736;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row>label{font-size:13px;color:var(--muted)}
    select,input[type='number']{background:#0e1218;border:1px solid #2a3140;border-radius:10px;color:var(--text);padding:8px 10px}
    input[type='checkbox']{transform:scale(1.1)}
    .pill{padding:6px 10px;border:1px solid #2a3140;border-radius:999px;font-size:12px;color:var(--muted)}
    .btn{cursor:pointer;border:none;border-radius:10px;padding:10px 12px;color:#0b0e13;font-weight:600;background:linear-gradient(180deg,#f0f4ff,#cfe8ff);}
    .btn.secondary{background:#273142;color:var(--text);border:1px solid #364258}
    .btn.danger{background:#402b2b;color:#ffd7d7;border:1px solid #5e3e3e}
    .btn.full{width:100%}
    .btn.small{padding:6px 9px;font-size:12px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .stack{display:grid;gap:12px}
    .section-title{font-weight:700;margin:4px 0 8px}
    .bar{height:10px;background:#1b2130;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#22d3ee,#38bdf8);width:0%}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .log{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;border:1px solid #263044;background:#121722;border-radius:10px;padding:8px 10px}
    .log.child{grid-template-columns:1fr auto auto auto;background:#0f141d;border:1px dashed #2a364c;margin-left:28px; font-size:0.66em; padding:6px 8px}
    .muted{color:var(--muted);font-size:12px}
    .pt-ok{color:var(--ok);font-weight:700}
    .chips{display:flex;flex-wrap:wrap;gap:6px}
    .chip{border:1px dashed #344055;border-radius:999px;padding:3px 8px;font-size:12px;color:#a9b6cb}
    .hr{height:1px;background:#232a38;margin:6px 0 10px}
    .note{font-size:12px;color:#9fb0c8}
    .xbtn{background:#2a3040;color:#cbd5e1;border:1px solid #3a4355;border-radius:8px;padding:4px 8px;font-size:12px;cursor:pointer}
    .xbtn:hover{background:#343c50}
    .tiny{font-size:11px}
    .truncate{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .panel{display:none}
    .panel.active{display:block}
    .dangerBanner{background:#3b1f20;border:1px solid #7f1d1d;color:#fecaca;padding:8px 10px;border-radius:10px}
    #footerNote{margin-top:12px;font-size:12px;color:#9fb0c8}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #273043;padding:6px 8px;text-align:left;font-size:13px}
    th{color:#c7d2fe}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="ja">カオゼロ</span><span class="en">（Chaos Zero Nightmare）</span>｜セーブデータ計算機</h1>
    <p class="sub">このページは Chaos Zero Nightmare（カオゼロ）のセーブデータ電卓です。</p>
    <p class="author">作者Xアカ <a href="https://x.com/CcMaashiro" target="_blank" rel="noopener">@CcMaashiro</a></p>

    <div class="tabs">
      <div class="tab active" data-panel="panelA">キャラA</div>
      <div class="tab" data-panel="panelB">キャラB</div>
      <div class="tab" data-panel="panelC">キャラC</div>
    </div>

    <div id="panelA" class="panel active"></div>
    <div id="panelB" class="panel"></div>
    <div id="panelC" class="panel"></div>

    <div id="footerNote">※ティアは全タブ共通です（どこで変更してもリンク）。他の設定・履歴は各タブで独立管理（ローカル保存対応）。</div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const TIER_KEY='czn_shared_tier_v1';
  const shared = {
    get tier(){ try{ return parseInt(localStorage.getItem(TIER_KEY)||'1',10)||1; }catch(_){ return 1; } },
    set tier(v){ localStorage.setItem(TIER_KEY, String(v)); document.dispatchEvent(new CustomEvent('czn:tier-changed',{detail:{tier:v}})); }
  };

  const NAME_KEY='czn_tab_names_v1';
  function loadTabNames(){ try{ return JSON.parse(localStorage.getItem(NAME_KEY)||'{}'); }catch(_){ return {}; } }
  function saveTabNames(map){ localStorage.setItem(NAME_KEY, JSON.stringify(map)); }
  const tabNames = loadTabNames();
  document.querySelectorAll('.tab').forEach(tab=>{
    const id = tab.getAttribute('data-panel');
    if(tabNames[id]) tab.textContent = tabNames[id];
    tab.setAttribute('title','ダブルクリックでタブ名を変更');
    tab.addEventListener('dblclick', (e)=>{
      e.preventDefault();
      const current = tab.textContent.trim();
      const name = prompt('タブ名を入力（例：凛 / 陽菜 / 編成A など）', current);
      if(name===null) return;
      const trimmed = name.trim();
      if(!trimmed) return;
      tab.textContent = trimmed;
      tabNames[id]=trimmed;
      saveTabNames(tabNames);
    });
  });

  function qs(root, sel){ return root.querySelector(sel); }
  const removeBaseN = (n)=>{ if (n<=1) return 0; if (n===2) return 10; if (n===3) return 30; if (n===4) return 50; return 70; };
  const copyBaseN   = (n)=>{ if (n<=1) return 0; if (n===2) return 10; if (n===3) return 30; if (n===4) return 50; return 70; };

  function buildCalculator(container, suffix){
    const STORAGE_KEY = `czn_panel_${suffix}_v1`;
    function loadState(){
      try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        return {
          nightmare: !!raw.nightmare,
          tierOffset: Number.isFinite(raw.tierOffset)? raw.tierOffset : 0,
          logsRaw: Array.isArray(raw.logsRaw)? raw.logsRaw : []
        };
      }catch(_){ return {nightmare:false, tierOffset:0, logsRaw:[]}; }
    }
    function saveState(){
      const data = {nightmare:state.nightmare, tierOffset:state.tierOffset, logsRaw:state.logsRaw};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    container.innerHTML = `
      <div class="grid">
        <div class="card">
          <div class="stack">
            <div class="row">
              <div class="row" style="gap:8px">
                <label>ティア</label>
                <select data-id="tier"></select>
              </div>
              <div class="row" style="gap:8px">
                <label>ナイトメア</label>
                <input type="checkbox" data-id="nightmare" />
                <span class="muted tiny">（+1ティア扱い）</span>
              </div>
              <div class="row" style="gap:8px">
                <label>追加ティア補正</label>
                <input type="number" data-id="tierOffset" value="0" step="1" min="0" style="width:90px" />
                <span class="muted tiny">CODEX等</span>
              </div>
              <div class="pill">上限 <span data-id="cap">—</span> pt</div>
            </div>

            <div>
              <div class="row" style="justify-content:space-between">
                <div class="muted">累計 <b data-id="spent">0</b> pt</div>
                <div class="muted">残り <b data-id="remain">0</b> pt</div>
              </div>
              <div class="bar"><span data-id="bar"></span></div>
            </div>

            <div class="section-title">単発イベント</div>
            <div class="grid-3">
              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between"><b>共用カード獲得</b><span class="muted">+20pt</span></div>
                  <button class="btn full" data-id="btn-common">共用カードを記録</button>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between"><b>モンスターカード獲得</b><span class="muted">+80pt</span></div>
                  <button class="btn full" data-id="btn-mon">モンスターカードを記録</button>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between"><b>カード変換</b><span class="muted">+10pt</span></div>
                  <div class="muted tiny">（履歴から後付け：ヒラメキ+10 / 神ヒラメキ+20）</div>
                  <button class="btn full" data-id="btn-conv">カード変換を記録</button>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between"><b>禁忌カード</b><span class="muted">+20pt（記録100%）</span></div>
                  <button class="btn full" data-id="btn-taboo">禁忌カードを記録</button>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between"><b>固有カード</b><span class="muted">±0pt</span></div>
                  <div class="muted tiny">後付け：ヒラメキは0pt、神ヒラメキは+20pt</div>
                  <button class="btn full" data-id="btn-unique">固有カードを記録</button>
                </div>
              </div>
            </div>

            <div class="section-title">回数で増えるイベント</div>
            <div class="grid-2">
              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between">
                    <b>排除</b><span class="muted">次回 = <b data-id="nextRemove">0</b> pt</span>
                  </div>
                  <div class="chips">
                    <label class="chip"><input type="checkbox" data-id="chk-remove-bonus" /> 開始固有カードの排除+20</label>
                    <label class="chip"><input type="checkbox" data-id="chk-remove-tag" /> 【排除】効果（この排除は0pt）</label>
                  </div>
                  <button class="btn full" data-id="btn-remove">排除を記録</button>
                  <div class="muted tiny">0→10→30→50→70（5回目以降70）／【排除】効果は0pt＆段階除外</div>
                </div>
              </div>

              <div class="card" style="padding:12px">
                <div class="stack">
                  <div class="row" style="justify-content:space-between">
                    <b>コピー</b><span class="muted">次回 = <b data-id="nextCopy">0</b> pt</span>
                  </div>
                  <div class="chips">
                    <label class="chip"><input type="checkbox" data-id="chk-copy-spark" /> ヒラメキ +10</label>
                    <label class="chip"><input type="checkbox" data-id="chk-copy-god" /> 神ヒラメキ +20</label>
                  </div>
                  <button class="btn full" data-id="btn-copy">コピーを記録</button>
                  <div class="muted tiny">0→10→30→50→70（5回目以降70）</div>
                </div>
              </div>
            </div>

            <div class="row" style="justify-content:flex-end;gap:8px">
              <button class="btn secondary small" data-id="btn-undo">戻す</button>
              <button class="btn danger small" data-id="btn-clear">クリア</button>
              <button class="btn small" data-id="btn-export">履歴CSV</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="stack">
            <div class="section-title">履歴</div>
            <div data-id="logs" class="stack" style="gap:8px"><div class="muted">まだ記録がありません。</div></div>
            <div class="hr"></div>

            <!-- Removed "サマリ" heading but keep the numbers -->
            <div class="stack">
              <div class="row" style="justify-content:space-between"><span class="muted">上限</span><b data-id="sumCap">— pt</b></div>
              <div class="row" style="justify-content:space-between"><span class="muted">累計</span><b data-id="sumSpent">0 pt</b></div>
              <div class="row" style="justify-content:space-between"><span class="muted">残り</span><b data-id="sumRemain">0 pt</b></div>
            </div>

            <div class="hr"></div>
            <div class="section-title">曖昧な記憶の記録確率（超過時の推定）</div>
            <div class="stack">
              <div data-id="tabooBanner" style="display:none" class="dangerBanner"></div>
              <div class="row" style="gap:10px">
                <div class="pill">実質上限 <span data-id="effCap">—</span> pt</div>
                <div class="pill">曖昧合計 <span data-id="ambTotal">—</span> pt</div>
                <label class="row" style="gap:6px">試行回数 <input data-id="trials" type="number" min="200" step="200" value="5000" style="width:90px"/></label>
                <button class="btn small" data-id="btn-prob">確率を計算</button>
              </div>
              <div data-id="probStatus" class="muted tiny"></div>
              <div data-id="probResult"></div>
            </div>

            <p class="note">禁忌カードは必ず記録（100%）→実質上限から控除。付随するヒラメキ/神ヒラメキは曖昧扱い。二段階抽選（親→子）で近似。</p>
          </div>
        </div>
      </div>
    `;

    // ---------- state & helpers ----------
    function loadState(){
      try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        return {
          nightmare: !!raw.nightmare,
          tierOffset: Number.isFinite(raw.tierOffset)? raw.tierOffset : 0,
          logsRaw: Array.isArray(raw.logsRaw)? raw.logsRaw : []
        };
      }catch(_){ return {nightmare:false, tierOffset:0, logsRaw:[]}; }
    }
    function saveState(){
      const data = {nightmare:state.nightmare, tierOffset:state.tierOffset, logsRaw:state.logsRaw};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    const state = loadState();
    const $ = (sel)=> qs(container, sel);
    const tokens = (s)=> (s||'').split('・').filter(Boolean);
    const hasToken = (s, t)=> tokens(s).includes(t);

    // query elements
    const tierSel = $('[data-id="tier"]');
    const nmCk = $('[data-id="nightmare"]');
    const tierOffset = $('[data-id="tierOffset"]');
    const capEl = $('[data-id="cap"]');
    const spentEl = $('[data-id="spent"]');
    const remainEl = $('[data-id="remain"]');
    const logs = $('[data-id="logs"]');
    const sumCap = $('[data-id="sumCap"]');
    const sumSpent = $('[data-id="sumSpent"]');
    const sumRemain = $('[data-id="sumRemain"]');
    const tabooBanner = $('[data-id="tabooBanner"]');
    const effCapEl = $('[data-id="effCap"]');
    const ambTotalEl = $('[data-id="ambTotal"]');
    const trialsEl = $('[data-id="trials"]');
    const probBtn = $('[data-id="btn-prob"]');
    const probStatus = $('[data-id="probStatus"]');
    const probResult = $('[data-id="probResult"]');
    const nextRemove = $('[data-id="nextRemove"]');
    const nextCopy = $('[data-id="nextCopy"]');
    const btnCommon = $('[data-id="btn-common"]');
    const btnMon = $('[data-id="btn-mon"]');
    const btnConv = $('[data-id="btn-conv"]');
    const btnTaboo = $('[data-id="btn-taboo"]');
    const btnUnique = $('[data-id="btn-unique"]');
    const btnRemove = $('[data-id="btn-remove"]');
    const btnCopy = $('[data-id="btn-copy"]');
    const btnUndo = $('[data-id="btn-undo"]');
    const btnClear = $('[data-id="btn-clear"]');
    const btnExport = $('[data-id="btn-export"]');

    // populate controls initial values
    for(let i=1;i<=30;i++){ const o=document.createElement('option'); o.value=String(i); o.textContent='T'+i; tierSel.appendChild(o); }
    function updateTierSelectFromShared(){ tierSel.value = String(shared.tier); }
    updateTierSelectFromShared();
    nmCk.checked = !!state.nightmare;
    tierOffset.value = String(state.tierOffset||0);

    // capacity
    const calcCap = ()=> 30 + 10*(Math.max(1,shared.tier)-1) + (state.nightmare?10:0) + 10*state.tierOffset;

    // compute totals
    function compute(){
      let removeCount=0, copyCount=0, spent=0;
      const arr = state.logsRaw.map((raw, idx)=>{
        const note = raw.note||'';
        let base=0, cS=0, cG=0;
        switch(raw.label){
          case '共用カード獲得': base=20; if(hasToken(note,'ヒラメキ+10')) cS=10; if(hasToken(note,'神ヒラメキ+20')) cG=20; break;
          case 'モンスターカード獲得': base=80; if(hasToken(note,'ヒラメキ+10')) cS=10; if(hasToken(note,'神ヒラメキ+20')) cG=20; break;
          case 'カード変換': base=10; if(hasToken(note,'ヒラメキ+10')) cS=10; if(hasToken(note,'神ヒラメキ+20')) cG=20; break;
          case '禁忌カード': base=20; if(hasToken(note,'ヒラメキ+10')) cS=10; if(hasToken(note,'神ヒラメキ+20')) cG=20; break;
          case '固有カード': base=0; if(hasToken(note,'ヒラメキ+0')) cS=0; if(hasToken(note,'神ヒラメキ+20')) cG=20; break;
          default:
            if(raw.label.startsWith('排除')){
              const hasEx = hasToken(note,'【排除】効果');
              if(!hasEx){ removeCount++; base = removeBaseN(removeCount) + (hasToken(note,'開始固有カードの排除+20')?20:0); }
            } else if(raw.label.startsWith('コピー')){
              copyCount++; base = copyBaseN(copyCount); if(hasToken(note,'ヒラメキ+10')) cS=10; if(hasToken(note,'神ヒラメキ+20')) cG=20;
            }
        }
        const total = base + cS + cG; spent += total;
        return { idx, raw, base, cS, cG, total };
      });
      return { arr, spent, nextRemove: removeBaseN(removeCount+1), nextCopy: copyBaseN(copyCount+1) };
    }

    function addNote(raw, part){
      if(raw.label==='固有カード' && part==='ヒラメキ+10') part='ヒラメキ+0';
      const set=new Set((raw.note||'').split('・').filter(Boolean)); set.add(part);
      if(raw.label==='固有カード' && set.has('ヒラメキ+10')){ set.delete('ヒラメキ+10'); set.add('ヒラメキ+0'); }
      raw.note=[...set].join('・'); render();
    }

    // render UI
    function render(){
      const cap=calcCap();
      const {arr, spent, nextRemove:nr, nextCopy:nc} = compute();
      const remain = Math.max(0, cap-spent);
      capEl.textContent=cap; spentEl.textContent=spent; remainEl.textContent=remain;
      qs(container, '[data-id="bar"]').style.width = (cap?Math.min(100,Math.max(0,spent/cap*100)):0).toFixed(2)+'%';
      nextRemove.textContent = nr; nextCopy.textContent = nc;
      sumCap.textContent=cap+' pt'; sumSpent.textContent=spent+' pt'; sumRemain.textContent=remain+' pt';

      const logsEl = logs;
      logsEl.innerHTML='';
      if(arr.length===0){ logsEl.innerHTML='<div class="muted">まだ記録がありません。</div>'; }
      arr.forEach((l,i)=>{
        const row = document.createElement('div'); row.className='log';
        const left = document.createElement('div'); left.className='truncate';
        const label = l.raw.label + (l.raw.note? `（${l.raw.note}）`:'');
        left.textContent = label + (l.raw.name? ` 【${l.raw.name}】` : '');
        const mid = document.createElement('div'); mid.className='row';

        if(l.raw.label.startsWith('排除')){
          if(!hasToken(l.raw.note,'【排除】効果')){ const b=document.createElement('button'); b.className='xbtn tiny'; b.textContent='+ 【排除】効果(0pt)'; b.onclick=()=>addNote(l.raw,'【排除】効果'); mid.appendChild(b); }
          if(!hasToken(l.raw.note,'開始固有カードの排除+20')){ const b=document.createElement('button'); b.className='xbtn tiny'; b.textContent='+ 開始固有カードの排除+20'; b.onclick=()=>addNote(l.raw,'開始固有カードの排除+20'); mid.appendChild(b); }
        }else{
          if(!(hasToken(l.raw.note,'ヒラメキ+10')||hasToken(l.raw.note,'ヒラメキ+0'))){
            const b=document.createElement('button'); b.className='xbtn tiny'; b.textContent=(l.raw.label==='固有カード'?'+ ヒラメキ+0':'+ ヒラメキ+10'); b.onclick=()=>addNote(l.raw,'ヒラメキ+10'); mid.appendChild(b);
          }
          if(!hasToken(l.raw.note,'神ヒラメキ+20')){ const b=document.createElement('button'); b.className='xbtn tiny'; b.textContent='+ 神ヒラメキ+20'; b.onclick=()=>addNote(l.raw,'神ヒラメキ+20'); mid.appendChild(b); }
        }
        const right = document.createElement('div'); right.innerHTML = `<span class="pt-ok">+${l.base} pt</span>`;
        const del = document.createElement('button'); del.className='xbtn tiny'; del.textContent='×'; del.onclick=()=>{ state.logsRaw.splice(i,1); render(); };
        row.appendChild(left); row.appendChild(mid); row.appendChild(right); row.appendChild(del);
        logsEl.appendChild(row);

        if ((l.raw.label!=='固有カード' && hasToken(l.raw.note,'ヒラメキ+10')) || (l.raw.label==='固有カード' && hasToken(l.raw.note,'ヒラメキ+0')) ){
          const r=document.createElement('div'); r.className='log child';
          r.innerHTML=`<div class="truncate">↳ ヒラメキ</div><div></div><div><span class="pt-ok">+${l.raw.label==='固有カード'?0:10} pt</span></div>`;
          const del2 = document.createElement('button'); del2.className='xbtn tiny'; del2.textContent='×'; del2.onclick=()=>{
            const parts=(l.raw.note||'').split('・').filter(x=>!(x==='ヒラメキ+10'||x==='ヒラメキ+0')); l.raw.note=parts.join('・'); render();
          };
          r.appendChild(del2); logsEl.appendChild(r);
        }
        if (hasToken(l.raw.note,'神ヒラメキ+20')){
          const r=document.createElement('div'); r.className='log child';
          r.innerHTML=`<div class="truncate">↳ 神ヒラメキ</div><div></div><div><span class="pt-ok">+20 pt</span></div>`;
          const del2 = document.createElement('button'); del2.className='xbtn tiny'; del2.textContent='×'; del2.onclick=()=>{
            const parts=(l.raw.note||'').split('・').filter(x=>x!=='神ヒラメキ+20'); l.raw.note=parts.join('・'); render();
          };
          r.appendChild(del2); logsEl.appendChild(r);
        }
      });

      // save to localStorage on every render
      saveState();
      renderProb();
    }

    // probability rendering
    function renderProb(){
      const cooked = compute().arr;
      const taboos = cooked.filter(x=>x.raw.label==='禁忌カード').length;
      const effCap = Math.max(0, calcCap() - 20*taboos);
      effCapEl.textContent = effCap;
      if (taboos>0){ tabooBanner.style.display='block'; tabooBanner.textContent=`⚠ 禁忌カード ${taboos} 枚あり：実質上限を ${20*taboos} pt 控除しています。`; }
      else { tabooBanner.style.display='none'; tabooBanner.textContent=''; }

      let ambTotal=0;
      cooked.forEach(l=>{
        if(l.base>0) ambTotal+=l.base;
        const note=l.raw.note||'';
        if(l.raw.label==='固有カード' && note.includes('ヒラメキ+0')) ambTotal+=0;
        if(note.includes('ヒラメキ+10')) ambTotal+=10;
        if(note.includes('神ヒラメキ+20')) ambTotal+=20;
      });
      ambTotalEl.textContent = ambTotal;

      const table = (rows)=>{
        if(rows.length===0){ probResult.innerHTML='<div class="muted">（結果なし。上限未超過か、試行回数を増やしてください）</div>'; return; }
        probResult.innerHTML = `<table><thead><tr><th>項目</th><th>pt</th><th>記録確率</th></tr></thead><tbody>`+
          rows.map(r=>`<tr><td>${r.label}</td><td>${r.cost}</td><td>${(r.p*100).toFixed(1)}%</td></tr>`).join('')+
          `</tbody></table>`;
      };

      if (ambTotal <= effCap){
        const rows=[];
        cooked.forEach(l=>{
          rows.push({label:l.raw.label, cost:(l.base>0?l.base:0), p:1});
          const note=l.raw.note||'';
          if((l.raw.label==='固有カード' && note.includes('ヒラメキ+0')) || note.includes('ヒラメキ+10')){
            rows.push({label:'↳ ヒラメキ', cost:(l.raw.label==='固有カード' && note.includes('ヒラメキ+0'))?0:10, p:1});
          }
          if(note.includes('神ヒラメキ+20')) rows.push({label:'↳ 神ヒラメキ', cost:20, p:1});
        });
        table(rows);
        return;
      }

      function simulate(trials){
        const map = new Map();
        function inc(key){ map.set(key,(map.get(key)||0)+1); }
        let valid=0;
        for(let t=0;t<trials;t++){
          let sum=0;
          const picked=new Set();

          cooked.forEach(l=>{
            if(l.base>0){ if(Math.random()<0.5){ sum+=l.base; picked.add(l.raw.label+'|'+l.base); } }
            else { picked.add(l.raw.label+'|0'); }
          });

          cooked.forEach(l=>{
            const note=l.raw.note||'';
            const parentPicked = l.base===0 || picked.has(l.raw.label+'|'+(l.base>0?l.base:0));
            if(!親Picked) return;
            if(l.raw.label==='固有カード' && note.includes('ヒラメキ+0')) picked.add('↳ ヒラメキ|0');
            if(note.includes('ヒラメキ+10') && Math.random()<0.5){ sum+=10; picked.add('↳ ヒラメキ|10'); }
            if(note.includes('神ヒラメキ+20') && Math.random()<0.5){ sum+=20; picked.add('↳ 神ヒラメキ|20'); }
          });

          if(sum<=effCap){
            valid++;
            picked.forEach(k=>inc(k));
          }
        }

        const rows=[];
        cooked.forEach(l=>{
          const key = l.raw.label+'|'+(l.base>0?l.base:0);
          rows.push({label:l.raw.label, cost:(l.base>0?l.base:0), p: (l.base===0?1: (valid?(map.get(key)||0)/valid:0))});
          const note=l.raw.note||'';
          if((l.raw.label==='固有カード' && note.includes('ヒラメキ+0')) || note.includes('ヒラメキ+10')){
            const cost=(l.raw.label==='固有カード' && note.includes('ヒラメキ+0'))?0:10;
            rows.push({label:'↳ ヒラメキ', cost, p: (valid?(map.get('↳ ヒラメキ|'+cost)||0)/valid:0)});
          }
          if(note.includes('神ヒラメキ+20')){
            rows.push({label:'↳ 神ヒラメキ', cost:20, p: (valid?(map.get('↳ 神ヒラメキ|20')||0)/valid:0)});
          }
        });
        return rows;
      }

      probBtn.onclick = ()=>{
        const btn=probBtn; btn.disabled=true; probStatus.textContent='計算中…';
        setTimeout(()=>{
          const trials = Math.max(200, parseInt(trialsEl.value||'5000',10));
          const rows = simulate(trials);
          probStatus.textContent='完了';
          btn.disabled=false;
          table(rows);
        },0);
      };
    }

    // listeners & persistence
    tierSel.addEventListener('change', e=>{ const v=parseInt(e.target.value,10)||1; if(shared.tier!==v) shared.tier=v; });
    document.addEventListener('czn:tier-changed', ()=>{ updateTierSelectFromShared(); render(); });
    nmCk.addEventListener('change', e=>{ state.nightmare=!!e.target.checked; render(); });
    tierOffset.addEventListener('input', e=>{ state.tierOffset=parseInt(e.target.value,10)||0; render(); });

    btnCommon.addEventListener('click', ()=>{ state.logsRaw.push({label:'共用カード獲得'}); render(); });
    btnMon.addEventListener('click', ()=>{ state.logsRaw.push({label:'モンスターカード獲得'}); render(); });
    btnConv.addEventListener('click', ()=>{ state.logsRaw.push({label:'カード変換'}); render(); });
    btnTaboo.addEventListener('click', ()=>{ state.logsRaw.push({label:'禁忌カード'}); render(); });
    btnUnique.addEventListener('click', ()=>{ state.logsRaw.push({label:'固有カード'}); render(); });
    btnRemove.addEventListener('click', ()=>{
      const parts=[];
      if(qs(container,'[data-id="chk-remove-bonus"]').checked) parts.push('開始固有カードの排除+20');
      if(qs(container,'[data-id="chk-remove-tag"]').checked) parts.push('【排除】効果');
      state.logsRaw.push({label:'排除', note: parts.join('・')||undefined});
      qs(container,'[data-id="chk-remove-bonus"]').checked=false;
      qs(container,'[data-id="chk-remove-tag"]').checked=false;
      render();
    });
    btnCopy.addEventListener('click', ()=>{
      const parts=[];
      if(qs(container,'[data-id="chk-copy-spark"]').checked) parts.push('ヒラメキ+10');
      if(qs(container,'[data-id="chk-copy-god"]').checked) parts.push('神ヒラメキ+20');
      state.logsRaw.push({label:'コピー', note: parts.join('・')||undefined});
      qs(container,'[data-id="chk-copy-spark"]').checked=false;
      qs(container,'[data-id="chk-copy-god"]').checked=false;
      render();
    });
    btnUndo.addEventListener('click', ()=>{ state.logsRaw.pop(); render(); });
    btnClear.addEventListener('click', ()=>{ state.logsRaw=[]; render(); });
    btnExport.addEventListener('click', ()=>{
      const headers = ['index','label','name','note','base','spark','god','total'];
      const calc=compute();
      const rows = calc.arr.map((l,i)=>[i+1,l.raw.label,(l.raw.name||''),(l.raw.note||''),l.base,l.cS,l.cG,l.total]);
      const csv = [headers.join(','), ...rows.map(r=>r.join(','))].join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`CZN_point_logs_${suffix}.csv`; a.click(); URL.revokeObjectURL(a.href);
    });

    // initial render
    render();
  }

  buildCalculator(document.getElementById('panelA'), 'A');
  buildCalculator(document.getElementById('panelB'), 'B');
  buildCalculator(document.getElementById('panelC'), 'C');

  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
      tab.classList.add('active');
      const id = tab.getAttribute('data-panel');
      document.getElementById(id).classList.add('active');
    });
  });
});
</script>
</body>
</html>
